# gencert-cli

## Usage

```
Usage: gencert-cli [options] <command> [args...]

OpenSSL command line management tool

Commands:
   gentmpl                    Generate default configurations that can be used as a template.
   gencert                    Generate a private key and signed certificate.
   certinfo                   Output certinfo about the given cert.
```

> 子命令及参数

- `参数`：无全局参数

- `子命令`：
    - `gentmpl`：生成 cfssl config 和 csr 配置模板
    - `gencert`：生成证书的 `私钥`、`CSR 请求证书` 和 `签名后的证书`
    - `certinfo`：查看签名后的证书信息

##  子命令

> `gentmpl`：生成 cfssl config 和 csr 配置模板

```
Usage: gencert-cli gentmpl [options]
       gencert-cli gentmpl -h|--help

Generate default configurations that can be used as a template

Options:
   --type                     Available: config and csr
```

`Tips`：使用 gencert 子命令生成证书时，会先调用 gentmpl 生成相关配置模板

> `gencert`：生成证书的 `私钥`、`CSR 请求证书` 和 `签名后的证书`

```
Usage: gencert-cli gencert [options]
       gencert-cli gencert -h|--help

generate a new key and signed certificate

Options:
   -i <interface>             The name of the interface,
                              and use the IP address to set alternative name that is certificate subject.
   --ca <string>              Set the CA certificate, must be PEM format.
   --cakey <string>           Set the CA key, must be PEM format.
   --newcert <string>         Set the type of the certificate. There are many preset options,
                              such as 'ca', 'admin', 'docker', 'etcd', 'flanneld', 'kubernetes',
                              'kube-controller-manager', 'kube-scheduler', 'kube-proxy'.
                              You can only choose one of them or custom.
                              If the certificate type is ca, you do not need to specify the '-ca' and '-cakey' options.
   --profile                  Specify which signing profile to use. You can choose one of the following:
                              - kubernetes and peer: with server and client authentication
                              - server: with server authentication
                              - client: with client authentication
   --certdir <string>         The directory where the certificate is stored.
                              By default, the new CA certificate directory is 'certs/CA',
                              the old CA certificate directory is 'certs/CA/old',
                              the other certifacate directory is 'cers/service'.
   --days <int>               The number of days a certificate generated by -x509 is valid for,
                              defaults to '7300 days (20 years, 175200 hours)'
   --hosts                    Host list for the certificate, could be a comma-separated list.
   --subject                  Specify the subject of the certificate. A valid format is
                              '/C=<country>/ST=<state>/L=<city>/O=<organization>/OU=<organization unit>/CN=<common name>'.
   --force                    Force CLI command to generate new certificates.
```

- `参数`：
    - `-i`：指定 NIC 网卡。默认时，`docker` 上的 server.pem 服务器证书，将使用此网卡的 IP 来限定证书可使用的 SAN 区域
    - `--ca`：指定 CA 证书路径，在生成非 ca 证书书时，必须指定此参数
    - `--cakey`：指定 CA 私钥路径，在生成非 ca 证书书时，必须指定此参数
    - `--newcert`：指定生成证书的类型，可自定义。例如 `--newcert filebeat` 将生成 filebeat 服务相关的证书和密钥
    - `--profile`：指定生成证书引用 ca-conf.json 哪个 profile 的配置。自定义 `--newcert` 时，需要指定此参数
    - `--certdir`：指定证书的存储路径
    - `--days`：指定证书的有效期限
    - `--hosts`：指定证书可使用的 SAN 区域。若 `--profile` 指定引用 kubernetes、server or peer 配置时，需要指定此参数
    - `--subject`：指定颁发的证书的 subject。自定义 `--newcert` 时，需要指定此参数
    - `--force`：当 `--newcert` 参数指定的证书类型已存在时，默认会提示是否继续。指定此参数时，则强制覆盖

- 目前已支持可签发的证书包括：
    - `ca`：自签 CA 证书。在指定 `--newcert ca` 时，请备份好 CA 证书
    - `admin`：client 客户端管理员证书，仅支持 `client auth`
    - `docker`：docker server 服务器证书，仅支持 `server auth`
    - `etcd`：peer 双向证书，支持 `server auth` 和 `client auth`
    - `flanneld`：client 客户端证书，仅支持 `client auth`
    - `kubernetes`：peer 双向证书，可用于 kubernetes api，支持 `server auth` 和 `client auth`
    - `kube-controller-manager`：peer 双向证书，支持 `server auth` 和 `client auth`
    - `kub-scheduler`：peer 双向证书，支持 `server auth` 和 `client auth`
    - `kube-proxy`：client 客户端证书，仅支持 `client auth`
    - `自定义证书`：例 registry、filebeat、consul 等其它需要证书的服务

> `certinfo`：查看签名后的证书信息

```
Usage: gencert-cli certinfo [options]
       gencert-cli certinfo -h|--help

output certinfo about the given cert

Options:
   --cert <string>            The path of signed or CSR certificate, must be PEM format.
   --raw                      Using the openssl raw command to output the certificate in text form.
                              By default, use 'cfssl certinfo' to output JSON form.
```

## Demo

### 下载安装包

```
$ git clone https://github.com/hjmallux/gencert-cli.git
```

> 目录树

```
$ gencert-cli/
├── README.md
├── cli
│   ├── cfssl
│   ├── cfssljson
│   └── gencert-cli
├── gencert-cli -> cli/gencert-cli
├── gitclean
└── gitkeep

1 directory, 7 files
```

### ( `可选` )：重新生成 CA 证书

> 生成 CA 证书

```
$ ./cli/gencert-cli gencert -i eth0 \
--days 7300 \
--newcert ca \
--subject /C=CN/ST=GuangDong/L=ShenZhen/O=OpsDev/OU=System/CN=CA
Warning: The certificate already exists. Continue ( yes / Default:no ): yes

## 命令返回结果：
---
2018/11/12 19:26:53 [INFO] generating a new CA key and certificate from CSR
2018/11/12 19:26:53 [INFO] generate received request
2018/11/12 19:26:53 [INFO] received CSR
2018/11/12 19:26:53 [INFO] generating key: rsa-2048
2018/11/12 19:26:53 [INFO] encoded CSR
2018/11/12 19:26:53 [INFO] signed certificate with serial number 358817235466296498882795800989993104991557327356
```
- 预设 CA 证书路径：`./certs/CA`
- 其它证书路径：`./certs/service`

> 校验 CA 证书信息

```
$ ./cli/gencert-cli certinfo --cert ./certs/CA/ca.pem --raw

## 命令返回结果：
---
Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number:
            07:47:40:f1:01:07:ed:2e:55:0a:6b:af:84:7e:57:37:f9:3b:bd:12
    Signature Algorithm: sha256WithRSAEncryption
        Issuer: C=CN, ST=GuangDong, L=ShenZhen, O=OpsDev, OU=System, CN=CA
        Validity
            Not Before: Nov 12 11:21:00 2018 GMT
            Not After : Nov 07 11:21:00 2038 GMT
        Subject: C=CN, ST=GuangDong, L=ShenZhen, O=OpsDev, OU=System, CN=CA
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: (2048 bit)
    ...
```

### 生成 `kubernetes` 平台证书

> 生成 `kubernetes` 证书

```
$ ./cli/gencert-cli gencert -i eth0 \
--ca ./certs/CA/ca.pem \
--cakey ./certs/CA/ca-key.pem \
--newcert kubernetes \
--hosts 127.0.0.1,10.0.0.17,10.0.0.18,10.0.0.19,10.254.0.1,kubernetes,kubernetes.default,kubernetes.default.svc,kubernetes.default.svc.cluster,kubernetes.svc.cluster.local

## 命令返回结果：
---
2018/11/12 19:36:21 [INFO] generate received request
2018/11/12 19:36:21 [INFO] received CSR
2018/11/12 19:36:21 [INFO] generating key: rsa-2048
2018/11/12 19:36:21 [INFO] encoded CSR
2018/11/12 19:36:21 [INFO] signed certificate with serial number 97850484005888002488341500095538236120681504957
```

- `--hosts`：限定证书允许使用的 SAN 区域，可同时指定多个 IP 或 domain，逗号隔开

> 查看证书允许使用的 SAN 区域

```
$ ./cli/gencert-cli certinfo --cert ./certs/service/kubernetes.pem --raw | grep 'Alternative Name' -A2

## 命令返回结果：
---
            X509v3 Subject Alternative Name:
                DNS:kubernetes, DNS:kubernetes.default, DNS:kubernetes.default.svc, DNS:kubernetes.default.svc.cluster, DNS:kubernetes.svc.cluster.local, IP Address:127.0.0.1, IP Address:10.0.0.17, IP Address:10.0.0.18, IP Address:10.0.0.19, IP Address:10.254.0.1
    Signature Algorithm: sha256WithRSAEncryption
```

### 生成 docker 证书

```
$ ./cli/gencert-cli gencert -i eth0 \
--ca ./certs/CA/ca.pem \
--cakey ./certs/CA/ca-key.pem \
--newcert docker \
--hosts localhost,10.0.0.203
```

### 自定义证书

- `例 1`：Harbor registry 证书

```
$ ./cli/gencert-cli gencert -i eth0 \
--ca ./certs/CA/ca.pem \
--cakey ./certs/CA/ca-key.pem \
--days 3650 \
--newcert registry.mydomain.com \
--profile server \
--hosts 10.0.0.203,registry.mydomain.com \
--subject /C=CN/ST=GuangDong/L=ShenZhen/O=OpsDev/OU=System/CN=registry.mydomain.com
```

## END
